{"version":3,"sources":["lib/store.js","lib/util.js","Terrain.js","Layer.js","Building.js","ModelView.js","Sidenav.js","ItemInfo.js","Clock.js","DetailView.js","model.js","App.js","index.js"],"names":["layersStateAtom","atom","entityAtom","detailEntityAtom","debugAtom","sm","SphericalMercator","RES","EXTENT_SHIFT","coordToPixel","lng","lat","z","mx","my","Math","log","tan","PI","res","coordToPlane","model","planeWidth","planeHeight","canvas","width","height","bbox","minlng","minlat","minx","miny","px","py","xyz","maxlng","maxlat","w","maxX","minX","size","h","maxY","minY","pixelToPlane","x","y","planeToCoord","planeToPixel","atan","exp","pixelToCoord","scaleCoord","coordToLocalPlane","ratioW","ratioH","TerrainContext","createContext","segments","BlankPlane","color","useContext","ModelContext","useState","setCoords","useAtom","store","debug","setDebug","useEffect","onDoubleClick","ev","shiftKey","stopPropagation","intersections","length","point","coord","util","val","coords","join","args","polygonOffset","polygonOffsetFactor","Terrain","levelmap","props","vertices","setVertices","geom","useUpdate","geometry","i","v","pos","verticesNeedUpdate","Array","from","ref","Provider","value","current","children","loader","SVGLoader","loadSVG","url","a","load","Promise","resolve","then","data","widthSVG","xml","viewBox","baseVal","heightSVG","paths","pathPoints","toShapes","forEach","shape","points","getPoints","map","p","push","catch","err","console","error","SVGMeshLayer","lines","setLines","visible","setVisible","terrain","svg","_lines","_points","THREE","setFromPoints","scale","merged","BufferGeometryUtils","mergeBufferGeometries","side","depthWrite","obj","setFromObject","getSize","position","set","translateX","translateY","line","getAttribute","array","floor","getTerrainAltitude","setAttribute","Float32Array","PNGLayer","texture","useLoader","transparent","opacity","Layer","def","basePath","path","URL","toString","format","fallback","Popup","item","style","minWidth","type","name","Building","base","depth","onPointerDown","originLng","originLat","origin","useMemo","moveTo","slice","reverse","lineTo","extrudeSettings","steps","bevelEnabled","hover","setHover","document","body","cursor","onClick","onPointerOver","onPointerOut","attach","pointerEvents","DefaultCamera","makeDefault","up","fov","aspect","window","innerWidth","innerHeight","near","far","blankTerrain","axios","get","resp","blankBuilding","routes","buildings","building","ModelView","setLevelmap","setBuildings","completeModel","layersState","setEntity","setDetailEntity","id","colorManagement","pixelRatio","min","devicePixelRatio","gl","powerPreference","antialias","useBridge","Object","values","modules","reduce","acc","module","concat","definition","layers","layer","enabled","target","minDistance","maxDistance","maxPolarAngle","Sidenav","communityURL","href","rel","fill","d","mdiHelpCircleOutline","mdiAccountGroup","requestFullscreen","webkitRequestFullscreen","call","mdiFullscreen","getField","entity","key","split","properties","encodeURIComponent","ModulePane","isOpen","paneOpen","setPaneOpen","moduleInfoOpen","setModuleInfoOpen","setLayersState","actions","filters","mdiInformationOutline","description","license","action","getProperty","missingFields","fields","field","params","assign_to","param","default_param","preventDefault","mdiOpenInNew","text","checked","onChange","state","assign","ItemInfo","iri","back","helpClicked","setHelpClicked","maxHeight","zIndex","mdiMenuUp","mdiMenuDown","entries","Clock","date","setDate","tick","_date","Date","toLocaleString","year","month","day","hour","minute","timer","setInterval","clearInterval","floors","floorN","floorHeight","floorsMetadata","floorGeom","floorGroup","activeFloor","setActiveFloor","anchorHover","setAnchorHover","anchorActive","setAnchorActive","floorMetadata","anchors","anchorGroup","j","userData","display","fontSize","fontWeight","position-z","metadata","ratio","center","getCenter","wireframe","DetailView","entityComponent","community","getModel","location","URLSearchParams","search","has","defaultModel","_basePath","Debug","debugOpen","setDebugOpen","mdiCloseCircle","App","setModel","modelLoaded","setModelLoaded","detailEntity","setItem","type_label","transitionRef","useRef","className","Transition","nodeRef","in","timeout","includes","mdiArrowLeftThinCircleOutline","ReactDOM","render","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.dd5235d0.chunk.js","sourcesContent":["import { atom } from 'jotai';\n\nconst layersStateAtom = atom({});\nconst entityAtom = atom(null);\nconst detailEntityAtom = atom(null);\nconst debugAtom = atom(null);\n\nexport { layersStateAtom, entityAtom, detailEntityAtom, debugAtom };\n","/*! Partly derived from https://gist.github.com/maptiler/fddb5ce33ba995d5523de9afdf8ef118 */\n\nimport SphericalMercator from '@mapbox/sphericalmercator';\n\nconst sm = new SphericalMercator();\n\nconst RES = 156543.03392804097;\nconst EXTENT_SHIFT = 20037508.342789244;\n\nfunction planeToPixel(model, x, y) {\n  const z = 18;\n\n  let xyz = sm.xyz(\n    [\n      model.bbox.minlng,\n      model.bbox.minlat,\n      model.bbox.maxlng,\n      model.bbox.maxlat,\n    ],\n    z,\n    true,\n  );\n\n  let w = (xyz.maxX - xyz.minX + 1) * sm.size,\n    h = (xyz.maxY - xyz.minY + 1) * sm.size;\n\n  let px = (x + model.canvas.width / 2) * (w / model.canvas.width),\n    py = (y + model.canvas.height / 2) * (h / model.canvas.height);\n  // let px = (x + model.canvas.width / 2) * (w / model.canvas.width),\n  //   py = (-y + model.canvas.height / 2) * (h / model.canvas.height);\n\n  return [px, py];\n}\n\nfunction pixelToPlane(model, px, py) {\n  const z = 18;\n\n  let xyz = sm.xyz(\n    [\n      model.bbox.minlng,\n      model.bbox.minlat,\n      model.bbox.maxlng,\n      model.bbox.maxlat,\n    ],\n    z,\n    true,\n  );\n\n  let w = (xyz.maxX - xyz.minX + 1) * sm.size,\n    h = (xyz.maxY - xyz.minY + 1) * sm.size;\n\n  let x = px * model.canvas.width / w - model.canvas.width / 2,\n    y = py * model.canvas.height / h - model.canvas.height / 2;\n  // let x = px * (model.canvas.width / w) - model.canvas.width / 2,\n  //   y = -(py * (model.canvas.height / h) - model.canvas.height / 2);\n\n  return [x, y];\n}\n\nfunction coordToPixel(lng, lat, z) {\n  let mx = lng * EXTENT_SHIFT / 180.0;\n  let my =\n    Math.log(Math.tan((90 + lat) * Math.PI / 360.0)) / (Math.PI / 180.0);\n  my = my * EXTENT_SHIFT / 180.0;\n\n  const res = RES / 2 ** z;\n  const px = (mx + EXTENT_SHIFT) / res;\n  const py = (my + EXTENT_SHIFT) / res;\n\n  return [px, py];\n}\n\nfunction pixelToCoord(px, py, z) {\n  const res = RES / 2 ** z;\n\n  const mx = px * res - EXTENT_SHIFT;\n  const my = py * res - EXTENT_SHIFT;\n\n  let lng = (mx / EXTENT_SHIFT) * 180.0;\n  let lat = (my / EXTENT_SHIFT) * 180.0;\n  lat =\n    (180 / Math.PI) *\n    (2 * Math.atan(Math.exp((lat * Math.PI) / 180.0)) - Math.PI / 2.0);\n\n  return [lng, lat];\n}\n\nfunction coordToPlane(model, lng, lat, planeWidth, planeHeight) {\n  planeWidth = planeWidth || model.canvas.width;\n  planeHeight = planeHeight || model.canvas.height;\n\n  const z = 18;\n\n  let [minx, miny] = coordToPixel(model.bbox.minlng, model.bbox.minlat, z);\n  let [absx, absy] = coordToPixel(lng, lat, z);\n  // let [minx, miny] = sm.px([model.bbox.minlng, model.bbox.maxlat], z);\n  // let [absx, absy] = sm.px([lng, lat], z);\n  let px = absx - minx,\n    py = absy - miny;\n\n  // console.log([lng, lat], [px, py]);\n\n  let [x, y] = pixelToPlane(model, px, py);\n\n  return { x, y };\n}\n\nfunction planeToCoord(model, x, y) {\n  const z = 18;\n  // let _x = x,\n  //   _y = y;\n\n  // console.log([x, y]);\n\n  [x, y] = planeToPixel(model, x, y);\n  let [minx, miny] = coordToPixel(model.bbox.minlng, model.bbox.minlat, z);\n  // let [minx, miny] = sm.px([model.bbox.minlng, model.bbox.maxlat], z);\n  let absx = minx + x,\n    absy = miny + y;\n\n  let [lng, lat] = pixelToCoord(absx, absy, z);\n  // let [lng, lat] = sm.ll([absx, absy], z);\n\n  return { lng, lat };\n}\n\nfunction scaleCoord(x) {\n  return x * 10000; // 1000000;\n}\n\nfunction coordToLocalPlane(model, lng, lat, planeWidth, planeHeight) {\n  planeWidth = planeWidth || model.canvas.width;\n  planeHeight = planeHeight || model.canvas.height;\n  let bboxW = scaleCoord(model.bbox.maxlng) - scaleCoord(model.bbox.minlng);\n  let bboxH = scaleCoord(model.bbox.maxlat) - scaleCoord(model.bbox.minlat);\n  let ratioW = planeWidth / bboxW;\n  let ratioH = planeHeight / bboxH;\n  let rellng = scaleCoord(lng) - scaleCoord(model.bbox.minlng);\n  let rellat = scaleCoord(lat) - scaleCoord(model.bbox.minlat);\n  let w = rellng * ratioW;\n  let h = rellat * ratioH;\n  // console.log(\n  //   bboxW,\n  //   bboxH,\n  //   ratioW,\n  //   ratioH,\n  //   rellng,\n  //   rellat,\n  //   w,\n  //   h,\n  //   w - model.canvas.width / 2,\n  //   h - model.canvas.height / 2,\n  // );\n  return {\n    x: w - planeWidth / 2,\n    y: h - planeHeight / 2,\n  };\n}\n\nfunction localPlaneToCoord(model, x, y) {\n  let bboxW = model.bbox.maxlng - model.bbox.minlng;\n  let bboxH = model.bbox.maxlat - model.bbox.minlat;\n  let ratioW = bboxW / model.canvas.width;\n  let ratioH = bboxH / model.canvas.height;\n  let lng = (x + model.canvas.width / 2) * ratioW;\n  let lat = (y + model.canvas.height / 2) * ratioH;\n  return {\n    lng: model.bbox.minlng + lng,\n    lat: model.bbox.minlat + lat,\n  };\n}\n\nexport { coordToPlane, planeToCoord, coordToLocalPlane, localPlaneToCoord };\n","import { createContext, useContext, useEffect, useState } from 'react';\nimport { useUpdate } from 'react-three-fiber';\n// import { Plane } from '@react-three/drei';\n// import { CameraHelper } from 'three';\nimport { useAtom } from 'jotai';\nimport * as store from './lib/store';\n\n// import tw from 'twin.macro';\n\nimport { ModelContext } from './ModelView';\nimport * as util from './lib/util';\n\nexport const TerrainContext = createContext();\n\nconst width = 1024,\n  height = 1024;\nconst segments = 100;\nconst terrainLevelZoom = 2;\n\nfunction BlankPlane({ width, height, color, ...props }) {\n  const { model } = useContext(ModelContext);\n\n  const [, setCoords] = useState([]);\n\n  const [debug, setDebug] = useAtom(store.debugAtom);\n\n  useEffect(() => {\n    if (!debug) setCoords([]);\n  }, [debug]);\n\n  return (\n    <mesh\n      onDoubleClick={(ev) => {\n        if (ev.shiftKey) {\n          ev.stopPropagation();\n          // console.log({ intersections: ev.intersections });\n          if (ev.intersections.length > 0) {\n            let point = ev.intersections[0].point;\n            // console.log(point);\n            let coord = util.planeToCoord(model, point.x, point.y);\n            // setCoords((val) => [...val, `[${coord.lat}, ${coord.lng}, 0]`]);\n            setCoords((val) => {\n              let coords = [...val, `[${coord.lng}, ${coord.lat}]`];\n              setDebug(`[${coords.join(', ')}]`);\n              return coords;\n            });\n          }\n        }\n      }}\n    >\n      <planeBufferGeometry args={[width, height]} />\n      <meshBasicMaterial\n        color={color || 0xf1f3f5}\n        polygonOffset={true}\n        polygonOffsetFactor={1}\n      />\n    </mesh>\n  );\n}\n\nfunction Terrain({ levelmap, ...props }) {\n  const [vertices, setVertices] = useState(null);\n\n  const geom = useUpdate(\n    (geometry) => {\n      let zoom = terrainLevelZoom;\n      for (let i = 0; i < levelmap.length; i++) {\n        let v = levelmap[i];\n        let pos = v[0] + segments * (segments - 1 - v[1]);\n        geometry.vertices[pos].z = v[2] * zoom;\n      }\n      geometry.verticesNeedUpdate = true;\n      setVertices(Array.from(geometry.vertices));\n    },\n    [levelmap],\n  );\n\n  return (\n    <>\n      <BlankPlane width={width} height={height} />\n      <mesh>\n        <planeGeometry\n          ref={geom}\n          args={[width, height, segments - 1, segments - 1]}\n        />\n        <meshBasicMaterial color={0xf8f9fa} />\n      </mesh>\n      <TerrainContext.Provider\n        value={{ geometry: geom.current, vertices: vertices }} // should be geom?\n      >\n        {props.children}\n      </TerrainContext.Provider>\n    </>\n  );\n}\n\nexport default Terrain;\n","import {\n  useContext,\n  useEffect,\n  // useRef,\n  useState,\n  Suspense,\n} from 'react';\nimport { useUpdate, useLoader } from 'react-three-fiber';\n\nimport { SVGLoader } from 'three/examples/jsm/loaders/SVGLoader';\nimport { BufferGeometryUtils } from 'three/examples/jsm/utils/BufferGeometryUtils';\nimport * as THREE from 'three';\n\nimport { TerrainContext } from './Terrain';\n\nconst width = 1024,\n  height = 1024;\nconst segments = 100;\n\nconst loader = new SVGLoader();\n\nasync function loadSVG(url) {\n  const load = () =>\n    new Promise((resolve) => {\n      loader.load(url, resolve);\n    });\n\n  return await load()\n    .then((data) => {\n      const widthSVG = data.xml.viewBox.baseVal.width;\n      const heightSVG = data.xml.viewBox.baseVal.height;\n      const paths = data.paths;\n      let pathPoints = [];\n\n      for (let i = 0; i < paths.length; i++) {\n        let path = paths[i];\n\n        const shapes = path.toShapes(true);\n\n        shapes.forEach((shape) => {\n          let points = shape.getPoints();\n\n          points = points.map((p) => {\n            let x = p.x;\n            if (x >= widthSVG) x = widthSVG - 1;\n            let y = heightSVG - p.y;\n            if (y < 0) y = 0;\n            if (y >= heightSVG) y = heightSVG - 1;\n            p.x = x;\n            p.y = y;\n            return p;\n          });\n\n          pathPoints.push(points);\n        });\n      }\n\n      return { pathPoints: pathPoints, width: widthSVG, height: heightSVG };\n    })\n    .catch((err) => {\n      console.error(err);\n    });\n}\n\nfunction SVGMeshLayer({ url, ...props }) {\n  const [lines, setLines] = useState([]);\n  const [visible, setVisible] = useState(false);\n\n  const terrain = useContext(TerrainContext);\n\n  useEffect(() => {\n    (async () => {\n      const svg = await loadSVG(url);\n\n      let _lines = [];\n\n      svg.pathPoints.forEach((points, i) => {\n        let _points = [];\n        points.forEach((p, i) => {\n          if (i > 0) {\n            _points.push(points[i - 1]);\n            _points.push(p);\n          }\n        });\n        const geometry = new THREE.BufferGeometry().setFromPoints(_points);\n        geometry.scale(width / svg.width, height / svg.height, 1);\n        _lines.push(geometry);\n      });\n\n      let merged = BufferGeometryUtils.mergeBufferGeometries(_lines);\n\n      setLines([\n        <lineSegments key={0} geometry={merged}>\n          <meshBasicMaterial\n            color={0xdadce0}\n            side={THREE.DoubleSide}\n            depthWrite={false}\n            // depthTest={false}\n          />\n        </lineSegments>,\n      ]);\n    })();\n  }, [url]);\n\n  const ref = useUpdate(\n    (obj) => {\n      let bbox = new THREE.Box3().setFromObject(obj);\n      let size = bbox.getSize(new THREE.Vector3());\n      obj.position.set(0, 0, 0);\n      obj.translateX(-size.x / 2);\n      obj.translateY(-size.y / 2);\n\n      function getTerrainAltitude(x, y) {\n        if (!terrain.vertices) return 0;\n        let pos =\n          Math.floor(x / (width / segments)) +\n          segments * (segments - 1 - Math.floor(y / (height / segments)));\n        if (pos < 0 || terrain.vertices.length <= pos) {\n          // console.log(x, y, pos);\n          return 0;\n        }\n        return terrain.vertices[pos].z;\n      }\n\n      // terrain\n      obj.children.forEach((line) => {\n        let position = line.geometry.getAttribute('position');\n        let vertices = [];\n        vertices = position.array.map((v, i) => {\n          if (i % 3 === 2) {\n            let z =\n              getTerrainAltitude(position.array[i - 2], position.array[i - 1]) +\n              2;\n            return z;\n          } else {\n            return v;\n          }\n        });\n        line.geometry.setAttribute(\n          'position',\n          new THREE.BufferAttribute(new Float32Array(vertices), 3),\n        );\n      });\n\n      setVisible(true);\n    },\n    [lines, terrain.vertices],\n  );\n\n  return (\n    <group ref={ref} visible={visible}>\n      {lines}\n    </group>\n  );\n}\n\nfunction PNGLayer({ url, ...props }) {\n  const terrain = useContext(TerrainContext);\n\n  const texture = useLoader(THREE.TextureLoader, url);\n\n  return (\n    <mesh geometry={terrain.geometry}>\n      <meshBasicMaterial\n        map={texture}\n        transparent={true}\n        color={0xffffff}\n        opacity={props.opacity ? props.opacity : 0.5}\n      />\n    </mesh>\n  );\n}\n\nfunction Layer({ def, basePath, ...props }) {\n  if (basePath) {\n    def.path = basePath ? (new URL(def.path, basePath)).toString() : def.path;\n  }\n  if (def.format === 'svg') {\n    return <SVGMeshLayer url={def.path} />;\n  } else if (def.format === 'png') {\n    return (\n      <Suspense fallback={null}>\n        <PNGLayer url={def.path} opacity={0.5} />\n      </Suspense>\n    );\n  }\n}\n\nexport default Layer;\n","import { useContext, useEffect, useMemo, useState } from 'react';\nimport * as THREE from 'three';\nimport { Html } from '@react-three/drei';\nimport tw from 'twin.macro';\n\nimport * as util from './lib/util';\n\nimport { ModelContext } from './ModelView';\n\nfunction Popup({ item, ...props }) {\n  return (\n    <div\n      css={[tw`bg-white border rounded py-2 px-3`]}\n      style={{ minWidth: '200px' }}\n    >\n      <div css={[tw`text-xs`]}>{item.type}</div>\n      <div>{item.name}</div>\n      <div css={[tw`mt-3 text-xs text-gray-600`]}>クリックで拡大</div>\n    </div>\n  );\n}\n\nfunction Building({ base, z, depth, onPointerDown, ...props }) {\n  const { model } = useContext(ModelContext);\n\n  const originLng = base[0][0],\n    originLat = base[0][1];\n\n  const origin = util.coordToPlane(model, originLng, originLat);\n\n  const geom = useMemo(() => {\n    const shape = new THREE.Shape();\n\n    shape.moveTo(0, 0);\n    base\n      .slice()\n      .reverse()\n      .forEach((v) => {\n        const p = util.coordToPlane(model, v[0], v[1]);\n        shape.lineTo(p.x - origin.x, p.y - origin.y);\n      });\n\n    const extrudeSettings = {\n      steps: 1,\n      depth: depth || 50,\n      bevelEnabled: false,\n    };\n    return new THREE.ExtrudeBufferGeometry(shape, extrudeSettings);\n  }, [model, base, origin.x, origin.y, depth]);\n\n  const [hover, setHover] = useState(false);\n\n  const color = {\n    default: 0xf1f3f4,\n    hover: 0x666666,\n  };\n\n  useEffect(() => {\n    document.body.style.cursor = hover ? 'pointer' : 'auto';\n  }, [hover]);\n\n  return (\n    <mesh\n      position={[origin.x, origin.y, z]}\n      geometry={geom}\n      onClick={props.onClick}\n      onPointerDown={onPointerDown}\n      onPointerOver={(ev) => {\n        ev.stopPropagation();\n        setHover(true);\n      }}\n      onPointerOut={(ev) => setHover(false)}\n    >\n      <meshLambertMaterial color={hover ? color.hover : color.default} />\n      <lineSegments>\n        <edgesGeometry attach=\"geometry\" args={[geom, 45]} />\n        <lineBasicMaterial color={0xcccccc} attach=\"material\" />\n      </lineSegments>\n      <Html style={{ pointerEvents: 'none' }}>\n        {hover && <Popup item={{ name: props.name, type: props.type }} />}\n      </Html>\n    </mesh>\n  );\n}\n\nexport default Building;\n","import { useEffect, createContext, useState } from 'react';\nimport { Canvas } from 'react-three-fiber';\nimport { OrbitControls, PerspectiveCamera } from '@react-three/drei';\n// import { CameraHelper } from 'three';\nimport axios from 'axios';\n\nimport { useAtom, Bridge, useBridge } from 'jotai';\nimport * as store from './lib/store';\n\nimport Terrain from './Terrain';\nimport Layer from './Layer';\nimport Building from './Building';\n\nexport const ModelContext = createContext();\n\nfunction DefaultCamera({ ...props }) {\n  // const camera = useRef();\n  // useHelper(camera, CameraHelper, 1, 'hotpink');\n\n  return (\n    <PerspectiveCamera\n      makeDefault\n      up={[0, 0, 1]}\n      position={[0, -800 * 1.2, 400 * 1.2]}\n      fov={60}\n      aspect={window.innerWidth / window.innerHeight}\n      near={1}\n      far={2048}\n      // ref={camera}\n    />\n  );\n}\n\nasync function completeModel(model, base) {\n  const blankTerrain = [];\n\n  if (model.terrain && model.terrain.path) {\n    model.terrain.path = base\n      ? new URL(model.terrain.path, base).toString()\n      : model.terrain.path;\n    model.terrain.data = await axios\n      .get(model.terrain.path)\n      .then((resp) => resp.data)\n      .catch(() => blankTerrain);\n  } else {\n    model.terrain = model.terrain || {};\n    model.terrain.data = blankTerrain;\n  }\n\n  const blankBuilding = {\n    routes: [],\n    buildings: [],\n  };\n\n  if (model.building && model.building.path) {\n    model.building.path = base\n      ? new URL(model.building.path, base).toString()\n      : model.building.path;\n    model.building.data = await axios\n      .get(model.building.path)\n      .then((resp) => resp.data)\n      .catch(() => blankBuilding);\n  } else {\n    model.building = model.building || {};\n    model.building.data = blankBuilding;\n  }\n\n  return model;\n}\n\nfunction ModelView({ model, basePath, ...props }) {\n  // console.log({ model: JSON.stringify(model) });\n\n  const [levelmap, setLevelmap] = useState([]);\n  const [buildings, setBuildings] = useState([]);\n\n  useEffect(() => {\n    completeModel(model, basePath).then((model) => {\n      setLevelmap(model.terrain.data);\n      setBuildings(model.building.data.buildings);\n    });\n  }, [model, basePath]);\n\n  const [layersState] = useAtom(store.layersStateAtom);\n  const [, setEntity] = useAtom(store.entityAtom);\n  const [, setDetailEntity] = useAtom(store.detailEntityAtom);\n\n  return (\n    <Canvas\n      id=\"model-view-canvas\"\n      colorManagement={false}\n      pixelRatio={Math.min(2, window.devicePixelRatio)}\n      gl={{ powerPreference: 'default', antialias: false }}\n    >\n      <DefaultCamera />\n      <ambientLight args={[0xffffff, 1]} />\n      <pointLight position={[10, 10, 10]} />\n      <Bridge value={useBridge()}>\n        <ModelContext.Provider value={{ model: model }}>\n          <Terrain levelmap={levelmap}>\n            {Object.values(model.modules)\n              .reduce((acc, module) => acc.concat(module.definition.layers || []), [])\n              .map((layer) =>\n                layersState[layer.id] && layersState[layer.id].enabled ? (\n                  <Layer key={layer.id} def={layer} basePath={basePath} />\n                ) : null,\n              )}\n            {buildings.map((building) => (\n              <Building\n                key={building.id}\n                base={building.base}\n                z={building.z}\n                depth={building.depth}\n                name={building.name}\n                type={building.type}\n                onPointerDown={(ev) => {\n                  ev.stopPropagation();\n                  setEntity(building);\n                  setDetailEntity(building);\n                }}\n              />\n            ))}\n          </Terrain>\n        </ModelContext.Provider>\n        )\n      </Bridge>\n      <OrbitControls\n        target={[0, 0, 0]}\n        minDistance={100}\n        maxDistance={1500}\n        maxPolarAngle={Math.PI / 2 - 0.1}\n      />\n    </Canvas>\n  );\n}\n\nexport default ModelView;\n","// import { useState } from 'react';\nimport { mdiHelpCircleOutline, mdiAccountGroup, mdiFullscreen } from '@mdi/js';\nimport tw from 'twin.macro';\n\nfunction Sidenav({ communityURL, ...props }) {\n  const HELP_URL = 'https://beta.owntwin.com/docs/about';\n\n  return (\n    <div css={[tw`fixed bottom-4 left-4 flex items-center h-10`]}>\n      <div css={[tw`mr-3 flex items-center`]}>\n        <a href={HELP_URL} target=\"_blank\" rel=\"noreferrer\">\n          <svg style={{ width: '24px', height: '24px' }} viewBox=\"0 0 24 24\">\n            <path fill=\"#000000\" d={mdiHelpCircleOutline} />\n          </svg>\n        </a>\n      </div>\n      {!!communityURL && (\n        <div css={[tw`mr-3 flex items-center`]}>\n          <a href={communityURL} target=\"_blank\" rel=\"noreferrer\">\n            <svg style={{ width: '24px', height: '24px' }} viewBox=\"0 0 24 24\">\n              <path fill=\"#000000\" d={mdiAccountGroup} />\n            </svg>\n          </a>\n        </div>\n      )}\n      <div css={[tw`flex items-center`]}>\n        <button\n          css={[tw`focus:outline-none`]}\n          onClick={() => {\n            const requestFullscreen =\n              document.body.requestFullscreen ||\n              document.body.webkitRequestFullscreen;\n            requestFullscreen.call(document.body);\n          }}\n        >\n          <svg style={{ width: '24px', height: '24px' }} viewBox=\"0 0 24 24\">\n            <path fill=\"#000000\" d={mdiFullscreen} />\n          </svg>\n        </button>\n      </div>\n    </div>\n  );\n}\n\nexport default Sidenav;\n","import { useState } from 'react';\n\nimport { useAtom } from 'jotai';\nimport * as store from './lib/store';\n\nimport tw from 'twin.macro';\nimport {\n  // mdiChevronUp, mdiChevronDown,\n  mdiMenuUp,\n  mdiMenuDown,\n  mdiInformationOutline,\n  mdiOpenInNew,\n} from '@mdi/js';\n\nfunction getField(entity, key) {\n  const splitted = key.split(':', 2);\n  if (splitted.length === 2) {\n    return entity && entity.properties && entity.properties[key]\n      ? encodeURIComponent(entity.properties[key])\n      : null;\n  } else {\n    return entity && entity[key] ? encodeURIComponent(entity[key]) : null;\n  }\n}\n\nfunction ModulePane({ id, module, properties, isOpen, ...props }) {\n  const [paneOpen, setPaneOpen] = useState(isOpen || false);\n  const [moduleInfoOpen, setModuleInfoOpen] = useState(false);\n\n  const [layersState, setLayersState] = useAtom(store.layersStateAtom);\n  const [entity] = useAtom(store.entityAtom);\n\n  const definition = module.definition;\n  const layers = definition.layers;\n  const actions = definition.actions || [];\n  const filters = [];\n\n  properties = properties || {};\n\n  return (\n    <div css={[tw`border-b`]}>\n      <div\n        css={[tw`px-3 py-2 cursor-pointer hover:bg-blue-100 flex flex-col`]}\n        onClick={(ev) => {\n          setPaneOpen(!paneOpen);\n        }}\n      >\n        <div css={[tw`flex items-center`]}>\n          <div css={[tw`flex-grow`]}>{definition.name}</div>\n          <div css={[tw`flex items-center`]}>\n            <div\n              css={[tw`rounded p-1 hover:bg-blue-200`]}\n              onClick={(ev) => {\n                if (paneOpen) {\n                  ev.stopPropagation();\n                  setModuleInfoOpen(!moduleInfoOpen);\n                } else {\n                  setModuleInfoOpen(true);\n                }\n              }}\n            >\n              <svg\n                css={[tw`fill-current text-gray-600`]}\n                style={{ width: '18px', height: '18px' }}\n                viewBox=\"0 0 24 24\"\n              >\n                <path d={mdiInformationOutline} />\n              </svg>\n            </div>\n          </div>\n        </div>\n      </div>\n      {paneOpen && (\n        <div css={[tw`px-3 pb-3 text-sm`]}>\n          {moduleInfoOpen && (\n            <div css={[tw`mb-2 mt-1`]}>\n              <div css={[tw`my-1`]}>説明</div>\n              <div css={[tw`p-2 text-sm bg-gray-100 rounded`]}>\n                <pre css={[tw`break-words whitespace-pre-wrap`]}>\n                  {definition.description || (\n                    <span css={[tw`text-gray-600`]}>未登録</span>\n                  )}\n                </pre>\n              </div>\n              <div css={[tw`mt-2 mb-1`]}>利用条件</div>\n              <div css={[tw`p-2 text-sm bg-gray-100 rounded`]}>\n                <pre css={[tw`break-words whitespace-pre-wrap`]}>\n                  {definition.license || (\n                    <span css={[tw`text-gray-600`]}>未登録</span>\n                  )}\n                </pre>\n              </div>\n            </div>\n          )}\n          <div css={[tw`mb-2`]}>\n            <div css={[tw`my-1`]}>アクション</div>\n            <ul>\n              {actions.length > 0 ? (\n                actions.map((action, i) => {\n                  const getProperty = (key) => {\n                    return (\n                      properties[`${id}:actions.${action.id}.${key}`] ||\n                      action[key] ||\n                      null\n                    );\n                  };\n                  const missingFields = [];\n\n                  if (!getProperty('href')) {\n                    missingFields.push('href');\n                  }\n\n                  if (!!action.fields) {\n                    action.fields.forEach((field) => {\n                      const ok = getField(entity, field) !== null;\n                      if (!ok) {\n                        missingFields.push(field);\n                      }\n                    });\n                  }\n\n                  function href() {\n                    const params = action.fields\n                      ? action.fields.map((field) => {\n                          const assign_to = getProperty(`fields.assign_to`); // TODO: Fix\n                          if (!assign_to) return '';\n                          const param = assign_to[field],\n                            value = getField(entity, field);\n                          if (!param || !value) return '';\n                          return `${param}=${value}`;\n                        })\n                      : [];\n\n                    return `${getProperty('href')}?${\n                      action.default_param ? `${action.default_param}&` : ''\n                    }${params.join('&')}`;\n                  }\n\n                  return (\n                    <li key={i}>\n                      <a\n                        href={href()}\n                        onClick={(ev) => {\n                          if (missingFields.length > 0) {\n                            ev.preventDefault();\n                            return false;\n                          }\n                        }}\n                        target=\"_blank\"\n                        rel=\"noreferrer\"\n                        css={[\n                          tw`flex items-center cursor-pointer hover:text-gray-800`,\n                        ]}\n                      >\n                        <svg\n                          css={[tw`fill-current text-black mr-0.5`]}\n                          style={{ width: '14px', height: '14px' }}\n                          viewBox=\"0 0 24 24\"\n                        >\n                          <path d={mdiOpenInNew} />\n                        </svg>\n                        <div\n                          css={[\n                            missingFields.length > 0 ? tw`line-through` : null,\n                          ]}\n                        >\n                          {action.text}\n                        </div>\n                      </a>\n                      {missingFields.length > 0 && (\n                        <div\n                          css={[\n                            tw`bg-gray-500 text-white rounded px-1 py-0.5 mb-0.5 text-xs`,\n                          ]}\n                        >\n                          情報を追加してください:{' '}\n                          <code>{missingFields.join(', ')}</code>\n                        </div>\n                      )}\n                    </li>\n                  );\n                })\n              ) : (\n                <li>\n                  <span css={[tw`text-gray-600`]}>未登録</span>\n                </li>\n              )}\n            </ul>\n          </div>\n          <div css={[tw`mb-2`]}>\n            <div css={[tw`my-1`]}>レイヤー</div>\n            <ul>\n              {layers.length > 0 ? (\n                layers.map((item, i) => {\n                  return (\n                    <li key={i}>\n                      <input\n                        css={[tw`mr-1`]}\n                        type=\"checkbox\"\n                        checked={layersState[item.id].enabled}\n                        onChange={(ev) => {\n                          setLayersState((state) => {\n                            state[item.id].enabled = !state[item.id].enabled;\n                            return Object.assign({}, state);\n                          });\n                        }}\n                      />\n                      {item.name}\n                    </li>\n                  );\n                })\n              ) : (\n                <li>\n                  <span css={[tw`text-gray-600`]}>未登録</span>\n                </li>\n              )}\n            </ul>\n          </div>\n          <div css={[tw`mb-2`]}>\n            <div css={[tw`my-1`]}>フィルター</div>\n            <ul>\n              {filters.length > 0 ? (\n                filters.map((item, i) => (\n                  <li key={i}>\n                    <span css={[tw`text-gray-600`]}>{item.name}</span>\n                  </li>\n                ))\n              ) : (\n                <li>\n                  <span css={[tw`text-gray-600`]}>未登録</span>\n                </li>\n              )}\n            </ul>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction ItemInfo({\n  name,\n  type,\n  iri,\n  item,\n  modules,\n  properties,\n  isOpen,\n  back,\n  ...props\n}) {\n  const [paneOpen, setPaneOpen] = useState(isOpen || false);\n  const [helpClicked, setHelpClicked] = useState(false);\n  const description = item.description || null;\n\n  return (\n    <div\n      css={[\n        tw`fixed top-4 left-4 flex flex-col bg-white shadow rounded right-4 sm:right-auto sm:w-72`,\n        paneOpen ? tw`bottom-20` : tw`bottom-auto`,\n      ]}\n      style={{ ...props.style, maxHeight: '40rem', zIndex: '20000000' }}\n    >\n      <div>\n        {back}\n        <div css={[back ? tw`border-t` : null, tw`py-2 px-3 rounded bg-white`]}>\n          <div css={[tw`text-xs`]}>{type}</div>\n          <div>{name}</div>\n          <div css={[tw`text-xs text-gray-600 break-all`]}>\n            {iri ? iri : '未登録'}\n          </div>\n        </div>\n      </div>\n      <div\n        css={[\n          tw`border-t flex justify-center cursor-pointer py-1 hover:bg-gray-100`,\n        ]}\n        onClick={() => {\n          setPaneOpen(!paneOpen);\n          !helpClicked && setHelpClicked(true);\n        }}\n      >\n        <div css={[tw`text-xs text-gray-800 flex items-center`]}>\n          <svg\n            css={[tw`fill-current text-gray-600`]}\n            style={{ width: '18px', height: '18px' }}\n            viewBox=\"0 0 24 24\"\n          >\n            <path d={paneOpen ? mdiMenuUp : mdiMenuDown} />\n          </svg>\n          {!helpClicked && <div>クリックで開く/閉じる</div>}\n        </div>\n      </div>\n      <div\n        css={[\n          paneOpen ? tw`block` : tw`hidden`,\n          tw`flex-grow overflow-y-scroll`,\n        ]}\n      >\n        <div css={[tw`mt-0 px-2 py-1 text-xs text-gray-800`]}>\n          インフォメーション\n        </div>\n        <div css={[tw`border rounded-sm py-2 px-3 m-2 mt-0`]}>\n          <div css={[tw`text-sm`, !description && tw`text-gray-600`]}>\n            {description ? description : '未登録'}\n          </div>\n        </div>\n        <div css={[tw`py-2`]}>\n          <div css={[tw`px-2 py-1 border-b text-xs text-gray-800`]}>\n            モジュール\n          </div>\n          {Object.entries(modules).map(([id, module]) => (\n            <ModulePane\n              key={id}\n              id={id}\n              module={module}\n              properties={properties}\n            />\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default ItemInfo;\n","import { useEffect, useState } from 'react';\nimport tw from 'twin.macro';\n\nfunction Clock({ ...props }) {\n  const [date, setDate] = useState();\n\n  useEffect(() => {\n    tick();\n    let timer = setInterval(() => tick(), 1000 * 30);\n\n    return function cleanup() {\n      clearInterval(timer);\n    };\n  });\n\n  function tick() {\n    let _date = new Date().toLocaleString('ja-JP', {\n      year: 'numeric',\n      month: 'numeric',\n      day: 'numeric',\n      hour: 'numeric',\n      minute: 'numeric',\n    });\n    setDate(_date);\n  }\n\n  return (\n    <div css={[tw`flex items-center`]}>\n      <div css={[tw`bg-white shadow rounded py-2 px-3 select-none`]}>{date}</div>\n    </div>\n  );\n}\n\nexport default Clock;\n","import {\n  useEffect,\n  useMemo,\n  createContext,\n  //  useRef,\n  useState,\n} from 'react';\nimport { Canvas, useUpdate } from 'react-three-fiber';\nimport { OrbitControls, PerspectiveCamera, Html } from '@react-three/drei';\nimport * as THREE from 'three';\n// import { CameraHelper } from 'three';\n\nimport { useAtom, Bridge, useBridge } from 'jotai';\nimport * as store from './lib/store';\nimport * as util from './lib/util';\n\nexport const ModelContext = createContext();\n\nfunction DefaultCamera({ ...props }) {\n  // const camera = useRef();\n  // useHelper(camera, CameraHelper, 1, 'hotpink');\n\n  return (\n    <PerspectiveCamera\n      makeDefault\n      up={[0, 0, 1]}\n      position={[0, -800 * 0.5, 400 * 0.5]}\n      fov={60}\n      aspect={window.innerWidth / window.innerHeight}\n      near={1}\n      far={2048}\n      // ref={camera}\n    />\n  );\n}\n\nfunction BlankPlane({ width, height, color, ...props }) {\n  return (\n    <mesh>\n      <planeBufferGeometry args={[width, height]} />\n      <meshBasicMaterial\n        color={color || 0xf1f3f5}\n        polygonOffset={true}\n        polygonOffsetFactor={1}\n      />\n    </mesh>\n  );\n}\n\nfunction Building({ model, base, depth, floor, floors, ...props }) {\n  const planeWidth = 250,\n    planeHeight = 250;\n\n  const [entity, setEntity] = useAtom(store.entityAtom);\n\n  const originLng = base[0][0],\n    originLat = base[0][1];\n\n    const origin = util.coordToLocalPlane(\n    model,\n    originLng,\n    originLat,\n    planeWidth,\n    planeHeight,\n  );\n\n  const shape = useMemo(() => {\n    const shape = new THREE.Shape();\n    shape.moveTo(0, 0);\n\n    base.forEach((v) => {\n      const p = util.coordToLocalPlane(\n        model,\n        v[0],\n        v[1],\n        planeWidth,\n        planeHeight,\n      );\n      shape.lineTo(p.x - origin.x, p.y - origin.y);\n    });\n\n    return shape;\n  }, [base, model, origin.x, origin.y]);\n\n  const geom = useMemo(() => {\n    const extrudeSettings = {\n      steps: 1,\n      depth: (depth || 50) * 0.2, // TODO: Fix\n      bevelEnabled: false,\n    };\n    return new THREE.ExtrudeBufferGeometry(shape, extrudeSettings);\n  }, [shape, depth]);\n\n  /* Floors */\n  let floorN = floor || 1;\n  let floorHeight = ((depth || 50) * 0.2) / floorN;\n  let floorsMetadata = floors ? floors : {};\n\n  const floorGeom = useMemo(() => new THREE.ShapeBufferGeometry(shape), [\n    shape,\n  ]);\n\n  let floorGroup = [];\n  const [activeFloor, setActiveFloor] = useState(null);\n  const [hover, setHover] = useState(null);\n  const [anchorHover, setAnchorHover] = useState(null);\n  const [anchorActive, setAnchorActive] = useState(null);\n\n  useEffect(() => {\n    if (entity.id !== anchorActive) {\n      setAnchorActive(null);\n    }\n  }, [entity.id, anchorActive]);\n\n  useEffect(() => {\n    document.body.style.cursor = hover || anchorHover ? 'pointer' : 'auto';\n  }, [hover, anchorHover]);\n\n  for (let i = 0; i < floorN; i++) {\n    let floorMetadata = floorsMetadata[`${i + 1}`] || {\n      texture: null,\n      anchors: [],\n    };\n    floorMetadata['n'] = `${i + 1}`;\n\n    const anchorGroup = floorMetadata.anchors.map((v, j) => {\n      // console.log(v);\n\n      let p = util.coordToLocalPlane(\n        model,\n        v.position.lng,\n        v.position.lat,\n        planeWidth,\n        planeHeight,\n      );\n\n      return (\n        <mesh\n          key={j}\n          position={[p.x - origin.x, p.y - origin.y, floorHeight / 2]}\n          userData={{ data: v }}\n          visible={activeFloor === null || activeFloor === i + 1}\n        >\n          <sphereBufferGeometry args={[0.1, 20, 20]} />\n          <meshBasicMaterial color={0x2196f3} />\n          <mesh\n            name=\"hitbox\"\n            visible={activeFloor === null || activeFloor === i + 1}\n            onPointerOver={(ev) => {\n              ev.stopPropagation();\n              activeFloor === i + 1 && setAnchorHover(v.id);\n            }}\n            onPointerOut={(ev) => {\n              ev.stopPropagation();\n              anchorHover === v.id && setAnchorHover(null);\n            }}\n            onPointerDown={(ev) => {\n              if (activeFloor !== i + 1 || !anchorHover === v.id) return;\n              ev.stopPropagation();\n              // TODO: Switch on click\n              // setLocalEntity(v);\n              setEntity(v);\n              setAnchorActive(v.id);\n            }}\n          >\n            <sphereBufferGeometry args={[1, 20, 20]} />\n            <meshBasicMaterial\n              visible={anchorHover === v.id || anchorActive === v.id}\n              color={0x2196f3}\n              opacity={0.5}\n              transparent={true}\n            />\n          </mesh>\n          <Html style={{ pointerEvents: 'none' }}>\n            <div\n              style={{\n                display:\n                  activeFloor === null || activeFloor === i + 1\n                    ? 'block'\n                    : 'none',\n                fontSize: '0.75rem',\n                fontWeight:\n                  anchorHover === v.id || anchorActive === v.id ? 'bold' : null,\n                width: '10rem',\n              }}\n            >\n              {v.name}\n            </div>\n          </Html>\n        </mesh>\n      );\n    });\n\n    let floor = (\n      <mesh\n        key={i}\n        position-z={floorHeight * i}\n        geometry={floorGeom}\n        userData={{ metadata: floorMetadata }}\n        onPointerDown={(ev) => {\n          if (!!anchorHover) return;\n          if (activeFloor === i + 1) {\n            ev.stopPropagation();\n            setActiveFloor(null);\n          } else if (activeFloor === null) {\n            ev.stopPropagation();\n            setActiveFloor(i + 1);\n          }\n        }}\n        onPointerOver={(ev) => {\n          if (activeFloor === null || activeFloor === i + 1) {\n            ev.stopPropagation();\n            setHover(i + 1);\n          }\n        }}\n        onPointerOut={(ev) => {\n          if (activeFloor === null || activeFloor === i + 1) {\n            ev.stopPropagation();\n            setHover(null);\n          }\n        }}\n        visible={activeFloor === null || activeFloor === i + 1}\n      >\n        <meshBasicMaterial\n          color={hover === i + 1 ? 0xaaaaaa : 0xf1f3f4}\n          side={THREE.DoubleSide}\n          visible={activeFloor === null || activeFloor === i + 1}\n        />\n        <lineSegments>\n          <edgesGeometry attach=\"geometry\" args={[floorGeom]} />\n          <lineBasicMaterial color={0xcccccc} attach=\"material\" />\n        </lineSegments>\n        <group name=\"anchors\">{anchorGroup}</group>\n      </mesh>\n    );\n\n    floorGroup.push(floor);\n  }\n\n  const ref = useUpdate((obj) => {\n    const bbox = new THREE.Box3().setFromObject(obj);\n    const size = bbox.getSize(new THREE.Vector3());\n\n    const ratio = Math.min(\n      (planeWidth - 32) / size.x,\n      (planeHeight - 32) / size.y,\n    );\n\n    obj.scale.set(ratio, ratio, ratio);\n\n    const center = bbox.getCenter(new THREE.Vector3());\n    obj.translateX(-center.x * ratio);\n    obj.translateY(-center.y * ratio);\n  }, []);\n\n  return (\n    <mesh ref={ref} position={[0, 0, 0]} geometry={geom}>\n      <meshLambertMaterial wireframe={true} visible={false} />\n      <lineSegments>\n        <edgesGeometry attach=\"geometry\" args={[geom, 45]} />\n        <lineBasicMaterial color={0xcccccc} attach=\"material\" />\n      </lineSegments>\n      <group name=\"floors\">{floorGroup}</group>\n    </mesh>\n  );\n}\n\nfunction DetailView({ model, type, entity, ...props }) {\n  let entityComponent;\n\n  if (entityComponent) entityComponent = null;\n\n  if (!!entity && type === 'building') {\n    entityComponent = (\n      <Building\n        key={entity.id}\n        model={model}\n        base={entity.base}\n        depth={entity.depth}\n        floor={entity.floor}\n        floors={entity.floors}\n      />\n    );\n  }\n\n  return (\n    <Canvas\n      id=\"detail-view-canvas\"\n      colorManagement={false}\n      pixelRatio={Math.min(2, window.devicePixelRatio)}\n      gl={{ powerPreference: 'default', antialias: false }}\n    >\n      <DefaultCamera />\n      <ambientLight args={[0xffffff, 1]} />\n      <pointLight position={[10, 10, 10]} />\n      <BlankPlane width={250} height={250} />\n      <Bridge value={useBridge()}>{entityComponent}</Bridge>\n      <OrbitControls\n        target={[0, 0, 0]}\n        minDistance={100}\n        maxDistance={500}\n        maxPolarAngle={Math.PI / 2 - 0.1}\n      />\n    </Canvas>\n  );\n}\n\nexport default DetailView;\n","const model = {\n  id: null,\n  name: null,\n  type: null,\n  iri: null,\n  url: null,\n  community: null,\n  description: null,\n  bbox: {\n    minlng: 139.647216796875,\n    minlat: 35.550105335885505,\n    maxlng: 139.658203125,\n    maxlat: 35.55904339525895,\n  },\n  canvas: {\n    width: 1024,\n    height: 1024,\n  },\n  terrain: null,\n  building: null,\n  modules: {},\n};\n\nexport { model };\n","import { useEffect, useRef, useState } from 'react';\nimport { Transition } from 'react-transition-group';\n\nimport { useAtom } from 'jotai';\nimport * as store from './lib/store';\n\nimport axios from 'axios';\n\nimport ModelView from './ModelView';\nimport Sidenav from './Sidenav';\nimport ItemInfo from './ItemInfo';\nimport Clock from './Clock';\nimport DetailView from './DetailView';\n\nimport tw from 'twin.macro';\nimport './App.css';\nimport { mdiArrowLeftThinCircleOutline, mdiCloseCircle } from '@mdi/js';\n\nimport { model as defaultModel } from './model';\n\n// const DEBUG = false;\n\nasync function getModel() {\n  let model, basePath, path;\n  const url = new URL(window.location);\n  const params = new URLSearchParams(url.search);\n  // TODO: Debug only\n  if (params.has('twin')) {\n    basePath = params.get('twin');\n    path = new URL('./twin.json', basePath);\n  } else {\n    basePath = null;\n    path = './twin.json';\n  }\n  model = await axios\n    .get(path)\n    .then((resp) => resp.data)\n    .catch(() => defaultModel);\n  model._basePath = basePath;\n\n  if (params.has('no-terrain')) {\n    model.terrain = null;\n  }\n\n  model.bbox = {\n    minlng: model.bbox[0],\n    minlat: model.bbox[1],\n    maxlng: model.bbox[2],\n    maxlat: model.bbox[3],\n  };\n\n  return model;\n}\n\nfunction Debug() {\n  const [debugOpen, setDebugOpen] = useState(false);\n  const [debug, setDebug] = useAtom(store.debugAtom);\n\n  useEffect(() => {\n    if (!!debug) setDebugOpen(true);\n  }, [debug]);\n\n  return (\n    <div\n      id=\"debug\"\n      css={[\n        tw`rounded-t-md bg-gray-800 text-white fixed bottom-0 left-0 right-0 h-48 p-4 text-sm shadow-md`,\n        debugOpen ? tw`block` : tw`hidden`,\n      ]}\n    >\n      <div\n        css={[tw`absolute top-4 right-4 cursor-pointer`]}\n        onClick={() => {\n          setDebugOpen(false);\n          setDebug('');\n        }}\n      >\n        <svg style={{ width: '18px', height: '18px' }} viewBox=\"0 0 24 24\">\n          <path fill=\"#eee\" d={mdiCloseCircle} />\n        </svg>\n      </div>\n      <div css={[tw`overflow-y-scroll w-full h-full`]}>{debug}</div>\n    </div>\n  );\n}\n\nfunction App() {\n  const [model, setModel] = useState({\n    id: null,\n    name: null,\n    type: null,\n    iri: null,\n    description: null,\n    modules: [],\n  });\n  const [modelLoaded, setModelLoaded] = useState(false);\n\n  const [, setLayersState] = useAtom(store.layersStateAtom);\n\n  const [entity, setEntity] = useAtom(store.entityAtom);\n  const [detailEntity, setDetailEntity] = useAtom(store.detailEntityAtom);\n  const [item, setItem] = useState({});\n\n  useEffect(() => {\n    (async () => {\n      let model = await getModel();\n      setModel(model);\n      setModelLoaded(true);\n    })();\n  }, []);\n\n  useEffect(() => {\n    setLayersState(() => {\n      const acc = {};\n\n      Object.entries(model.modules).forEach(([id, module]) => {\n        const layers = module.definition.layers || [];\n        layers.forEach((layer) => {\n          acc[`${layer.id}`] = {\n            enabled:\n              model.properties[`${id}:layers.${layer.id}.enabled`] || false,\n          };\n        });\n      });\n\n      return acc;\n    });\n  }, [setLayersState, model.modules, model.properties]);\n\n  useEffect(() => {\n    !entity && model && model.id && setEntity(model);\n    if (!entity) return;\n    setItem({\n      name: entity.name,\n      type: entity.type_label || entity.type,\n      iri: entity.iri,\n      description: entity.description,\n    });\n  }, [entity, setEntity, model]);\n\n  const transitionRef = useRef(null);\n\n  return (\n    <div\n      className=\"App\"\n      id=\"App\"\n      css={[tw`fixed top-0 bottom-0 left-0 right-0`]}\n    >\n      <div\n        css={[\n          tw`absolute top-0 bottom-0 left-0 right-0 flex justify-center items-center text-sm text-gray-400 pointer-events-none`,\n          !detailEntity ? tw`flex` : tw`hidden`,\n        ]}\n      >\n        <div>表示されない場合は再読み込み</div>\n      </div>\n      <div\n        css={[\n          tw`absolute top-0 bottom-0 left-0 right-0`,\n          !detailEntity ? tw`block` : tw`hidden`,\n        ]}\n      >\n        {modelLoaded && <ModelView model={model} basePath={model._basePath} />}\n      </div>\n      <Transition nodeRef={transitionRef} in={!!detailEntity} timeout={1}>\n        {(state) => (\n          <div\n            ref={transitionRef}\n            className=\"detail-view\"\n            css={[\n              tw`absolute top-0 bottom-0 left-0 right-0`,\n              ['entering', 'entered'].includes(state) ? tw`block` : tw`hidden`,\n            ]}\n          >\n            <div\n              css={[\n                tw`w-full h-full`,\n                state === 'entered' ? tw`block` : tw`hidden`,\n              ]}\n            >\n              {modelLoaded && (\n                <DetailView\n                  model={model}\n                  type={'building'}\n                  entity={detailEntity}\n                />\n              )}\n            </div>\n          </div>\n        )}\n      </Transition>\n      {modelLoaded && (\n        <ItemInfo\n          name={item.name}\n          type={item.type}\n          iri={item.iri}\n          item={item}\n          modules={model.modules}\n          properties={model.properties}\n          back={\n            detailEntity && (\n              <div\n                css={[\n                  tw`text-sm text-gray-600 px-2 py-2 cursor-pointer flex items-center bg-gray-50 hover:bg-gray-100`,\n                ]}\n                onClick={(ev) => {\n                  ev.stopPropagation();\n                  if (detailEntity.id === entity.id) {\n                    setDetailEntity(null);\n                    setEntity(null);\n                  } else {\n                    setEntity(detailEntity);\n                  }\n                }}\n              >\n                <div css={[tw`mr-1`]}>\n                  <svg\n                    style={{ width: '18px', height: '18px' }}\n                    viewBox=\"0 0 24 24\"\n                  >\n                    <path fill=\"#888\" d={mdiArrowLeftThinCircleOutline} />\n                  </svg>\n                </div>\n                <div>戻る</div>\n              </div>\n            )\n          }\n        />\n      )}\n      <Debug />\n      <div css={[tw`absolute top-4 left-auto right-4 hidden sm:block`]}>\n        <Clock />\n      </div>\n      {modelLoaded && <Sidenav communityURL={model.community} />}\n      <a href=\"//beta.owntwin.com\" css={[tw`cursor-pointer`]}>\n        <div\n          className=\"logo\"\n          css={[\n            tw`absolute bottom-4 left-auto right-4 opacity-75 font-bold text-white bg-gray-500 rounded px-3 py-2`,\n          ]}\n        >\n          <div>OwnTwin</div>\n        </div>\n      </a>\n    </div>\n  );\n}\n\nexport default App;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\nimport { GlobalStyles } from 'twin.macro';\nimport { Provider } from 'jotai';\n\nReactDOM.render(\n  <React.StrictMode>\n    <GlobalStyles />\n    <Provider>\n      <App />\n    </Provider>\n  </React.StrictMode>,\n  document.getElementById('root'),\n);\n"],"sourceRoot":""}